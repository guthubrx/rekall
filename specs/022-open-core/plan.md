# Implementation Plan: 022-open-core

**Branch**: `022-open-core` | **Date**: 2025-12-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/022-open-core/spec.md`

## Summary

Introduire des interfaces abstraites (ABC) pour les backends Database et Cache dans rekall, permettant le modèle Open Core où le repo public contient les interfaces + implémentations par défaut, et un repo privé (rekall-server) peut fournir des backends optimisés.

**Approche technique:** ABC (Abstract Base Classes) + ServiceContainer singleton + implémentations par défaut.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: abc (stdlib), typing (stdlib), threading (stdlib)
**Storage**: SQLite (existant, devient DefaultDatabaseBackend)
**Testing**: pytest (existant)
**Target Platform**: CLI, MCP server (Linux, macOS, Windows)
**Project Type**: single (library/CLI)
**Performance Goals**: <50ms overhead au démarrage
**Constraints**: Zéro breaking change pour utilisateurs Home, ~300 lignes max d'overhead
**Scale/Scope**: 2 interfaces (DatabaseBackend, CacheBackend), 1 container

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principe | Statut | Notes |
|----------|--------|-------|
| Rekall memory | ✅ OK | Feature améliore rekall, pas de conflit |
| Simplicité | ✅ OK | 2 interfaces seulement, pas d'over-engineering |

**Gate Status:** PASSED

## Project Structure

### Documentation (this feature)

```text
specs/022-open-core/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
│   └── interfaces.py    # API contracts
├── checklists/
│   └── requirements.md  # Validation checklist
└── tasks.md             # Phase 2 output (à générer)
```

### Source Code (repository root)

```text
rekall/
├── infra/                    # NOUVEAU - Module infrastructure
│   ├── __init__.py           # Exports publics
│   ├── interfaces.py         # ABC: DatabaseBackend, CacheBackend
│   ├── container.py          # ServiceContainer singleton
│   └── defaults.py           # DefaultDatabaseBackend, DefaultCacheBackend
├── db.py                     # MODIFIÉ - Utilise get_database()
├── cache.py                  # MODIFIÉ - Utilise get_cache()
└── config.py                 # MODIFIÉ - Ajout option debug

tests/
├── unit/
│   ├── test_interfaces.py    # NOUVEAU - Tests ABC
│   └── test_container.py     # NOUVEAU - Tests ServiceContainer
└── integration/
    └── test_backends.py      # NOUVEAU - Tests intégration backends
```

**Structure Decision**: Single project, ajout du module `rekall/infra/` pour les interfaces et le container. Pas de restructuration majeure.

## Implementation Phases

### Phase 1: Interfaces et Container (~100 lignes)

1. Créer `rekall/infra/__init__.py`
2. Créer `rekall/infra/interfaces.py` avec ABC
3. Créer `rekall/infra/container.py` avec ServiceContainer
4. Tests unitaires pour interfaces et container

### Phase 2: Implémentations par défaut (~100 lignes)

1. Créer `rekall/infra/defaults.py`
2. Adapter le code existant de `db.py` en DefaultDatabaseBackend
3. Adapter le code existant de `cache.py` en DefaultCacheBackend
4. Enregistrement automatique au démarrage

### Phase 3: Refactoring minimal (~50 lignes modifiées)

1. Modifier `db.py` pour utiliser `get_database()`
2. Modifier `cache.py` pour utiliser `get_cache()`
3. Ajouter option `debug` dans `config.py`
4. S'assurer que tous les tests existants passent

### Phase 4: Documentation et tests d'intégration

1. Tests d'intégration backends
2. Mise à jour de la documentation
3. Vérification SC-001 à SC-005

## Complexity Tracking

Aucune violation de constitution détectée.

## Dependencies

```
Aucune nouvelle dépendance externe.
Utilise uniquement la stdlib Python:
- abc
- typing
- threading
```

## Risks Identified

| Risque | Probabilité | Impact | Mitigation |
|--------|-------------|--------|------------|
| Régression tests | Faible | Critique | Exécuter pytest après chaque changement |
| Overhead performance | Faible | Moyen | Profiling avant/après, limite 50ms |
| Breaking changes | Faible | Critique | API publique inchangée |

## Next Steps

1. **Générer tasks.md** avec `/speckit.tasks`
2. **Implémenter** avec `/speckit.implement`
3. **Valider** SC-001 à SC-005

---

*Generated by `/speckit.plan` on 2025-12-13*
