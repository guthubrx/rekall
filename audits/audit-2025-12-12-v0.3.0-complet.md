# Audit de sÃ©curitÃ© & qualitÃ© â€” Rekall

Date du rapportÂ : 2025â€‘12â€‘12  
Version auditÃ©eÂ : Rekall v0.3.0  
RepositoryÂ : https://github.com/guthubrx/rekall (analyse sur workspace local)  

## ğŸ“Š RÃ‰SUMÃ‰ EXÃ‰CUTIF

- **Score global de santÃ©**Â : **B+**  
  Base saine et en nette amÃ©lioration (CI, lockfile, durcissements rÃ©cents), mais reste de la dette structurelle sur les â€œmain modulesâ€ et un manque de chiffrement au repos.
- **Scores par catÃ©gorie**Â :
  - SÃ©curitÃ©Â : **B+**
  - QualitÃ© de codeÂ : **B**
  - ArchitectureÂ : **B**
  - TestsÂ : **B+**
  - PerformanceÂ : **B**
  - ObservabilitÃ©Â : **C+**
  - ConformitÃ©Â : **B**
  - CI/CD & Supply ChainÂ : **Aâ€‘**
- **Top 5 des problÃ¨mes critiques Ã  rÃ©soudre immÃ©diatement**
  1. **Modules monolithiques trÃ¨s volumineux** (`rekall/tui_main.py`, `rekall/cli_main.py`, `rekall/db.py`) â†’ maintenabilitÃ©/risque rÃ©gression.
  2. **Pas de chiffrement SQLite au repos** â†’ risque si PII/secrets stockÃ©s.
  3. **Chemins de backups incohÃ©rents** (global `~/.rekall/backups` vs projet local) â†’ confusion/risque dâ€™erreur.
  4. **Docs â€œ100% local / nowhere else everâ€ trop absolues** malgrÃ© features rÃ©seau optâ€‘in (embeddings download, linkâ€‘rot). 
  5. **CI ne teste pas Python 3.9** alors que supportÃ© â†’ compatibilitÃ© partiellement couverte.
- **Dette technique**Â : **modÃ©rÃ©e** (rÃ©duite par modularisation rÃ©cente, mais encore concentrÃ©e sur 3 gros fichiers).

## Couverture checklist (statut)

### SÃ©curitÃ© & QualitÃ©
- [x] OWASP Top 10 adaptÃ© Ã  une CLI localâ€‘first (voir section dÃ©diÃ©e)
- [x] Secrets/donnÃ©es sensiblesÂ : pas de secrets versionnÃ©s dÃ©tectÃ©s; CI gitleaks en place.
- [ ] Chiffrement des donnÃ©es SQLiteÂ : **issue** (voir finding Sâ€‘1).
- [x] Authentification/AutorisationÂ : **N/A** (pas de service multiâ€‘tenant; MCP en stdio).
- [x] PII/RGPDÂ : **N/A/usageâ€‘dÃ©pendant** (outil local; docs Ã  clarifier).
- [x] Validation dâ€™entrÃ©esÂ : URL validation durcie, schÃ©mas Pydantic, CLI strict.
- [x] Durcissement archives/importsÂ : ZIP validÃ© + checksum (pas dâ€™extraction disque).
- [x] DÃ©pendances & supply chainÂ : versions bornÃ©es + `uv.lock` + `pip-audit` CI.
- [x] CI/CD & scansÂ : tests/lint/pipâ€‘audit/gitleaks.
- [x] Config & secretsÂ : TOML robuste via tomlkit + perms 600.
- [x] Durcissement environnementsÂ : localâ€‘first, perms fichiers, timeouts rÃ©seau.

### QualitÃ©, Architecture & MaintenabilitÃ©
- [x] Linting/formatÂ : Ruff check + format + Bandit rules.
- [x] DRY/duplicationÂ : faible duplication visible.
- [x] SÃ©paration couchesÂ : packages `cli/`, `ui/`, `services/`, `infra/`.
- [ ] CLI monolithique vs modularisationÂ : **issue** sur `cli_main.py` (Mâ€‘1).
- [x] CohÃ©rence conventionsÂ : bonne, mais encore hÃ©tÃ©rogÃ¨ne dans anciens modules.
- [x] Code mort/features fantÃ´mesÂ : 1 TODO notable embeddings (Mâ€‘3).
- [x] Patterns/antiâ€‘patternsÂ : â€œmain modulesâ€ encore Godâ€‘objects.
- [x] Gestion erreurs/rÃ©silienceÂ : timeouts et fallbacks prÃ©sents; logs parfois silencieux.
- [x] Persistance config/migrationsÂ : PRAGMA user_version + migrations atomiques.

### ObservabilitÃ© & ExploitabilitÃ©
- [x] LogsÂ : prÃ©sents mais non structurÃ©s (Oâ€‘1).
- [x] Erreurs userâ€‘facingÂ : Typer/Textual avec messages corrects.
- [x] Journaux dâ€™auditÂ : partiel (imports/backups), pas de log sÃ©curitÃ© dÃ©diÃ©.
- [x] Health checksÂ : **N/A** (pas de service HTTP longâ€‘lived).
- [x] Codes retour CLIÂ : ok (Typer Exit).

### Tests, Performance & DonnÃ©es
- [x] StratÃ©gie testsÂ : unitaires + intÃ©gration DB + intÃ©grations MCP.
- [x] Zones critiques couvertesÂ : DB, import/export, connectors.
- [x] Perf & scalabilitÃ©Â : FTS5 + WAL + index; embeddings optâ€‘in.
- [x] IntÃ©gritÃ© donnÃ©esÂ : transactions + checkpoints WAL + `PRAGMA integrity_check`.
- [ ] Gestion SQLite chiffrementÂ : **issue** (Sâ€‘1).

### Documentation & ExpÃ©rience DÃ©veloppeur
- [x] README/onboarding complet + multiâ€‘langues.
- [x] Docs CLI/MCP dÃ©taillÃ©es.
- [x] Scripts DXÂ : `uv` recommandÃ©, CI vÃ©rifie lock.
- [x] Versioning/changelogÂ : semver + `CHANGELOG.md`.

### HygiÃ¨ne du code IA
- [x] DÃ©tection IAÂ : surtout dans docs research (mention explicite).
- [x] CohÃ©rence/sÃ©curitÃ© du code IAÂ : pas dâ€™indicateurs dans core.
- [x] RÃ©duction redondance IAÂ : N/A.
- [x] Tests/doc ajoutÃ©s pour zones complexes.
- [x] Licences/snippets IAÂ : pas dâ€™indices de copie brute.

---

## OWASP Top 10 (adaptÃ© Ã  une CLI)

- **A01 Broken Access Control / A07 Auth failures**Â : N/A (outil local monoâ€‘utilisateur, pas dâ€™API exposÃ©e).  
- **A02 Cryptographic Failures**Â : chiffrement au repos absent (Sâ€‘1).  
- **A03 Injection**Â : SQL paramÃ©trÃ© et pas dâ€™`eval/exec/pickle` dÃ©tectÃ©s.  
- **A04 Insecure Design**Â : architecture localâ€‘first saine; risques surtout liÃ©s Ã  la dette de modules monolithiques.  
- **A05 Security Misconfiguration**Â : docs trop absolues sur â€œofflineâ€ (Dâ€‘1).  
- **A06 Vulnerable Components**Â : versions bornÃ©es + lock + CI pipâ€‘audit.  
- **A08 Software/Data Integrity Failures**Â : archives signÃ©es par checksum, CI + lock.  
- **A09 Logging/Monitoring Failures**Â : logs pas structurÃ©s (Oâ€‘1), acceptable CLI mais amÃ©liorable.  
- **A10 SSRF**Â : durcissement URL + DNS + blocage IP privÃ©es (positif).

---

## ğŸš¨ FINDINGS CRITIQUES (SÃ©curitÃ© & DonnÃ©es)

### [MOYENNE] Sâ€‘1 â€” SQLite non chiffrÃ©e au repos

CatÃ©gorieÂ : Chiffrement, SQLite, PII  
Fichier(s)Â : `rekall/db.py:459`  
DescriptionÂ : la base SQLite est ouverte via `sqlite3.connect` sans couche de chiffrement. Les fichiers sont protÃ©gÃ©s par permissions 600 (`rekall/db.py:462-463`, `rekall/utils.py:15-36`), mais restent lisibles si le disque/backup est compromis.  
ImpactÂ : fuite possible de contenus sensibles (prompts, URLs internes, notes, PII) via accÃ¨s filesystem ou backup partagÃ©.  
PreuveÂ : connexion SQLite standard (`rekall/db.py:459`) + absence de `sqlcipher`/encryption dans le code.  
RemÃ©diationÂ :
- **Documenter clairement** que la sÃ©curitÃ© repose sur le chiffrement disque/OS.  
- **Optionnel (optâ€‘in)**Â : support SQLCipher, exÂ :
  ```python
  import pysqlcipher3.dbapi2 as sqlite3
  conn = sqlite3.connect(str(db_path))
  conn.execute(f"PRAGMA key = '{key}'")
  ```
  avec clÃ© fournie via env/Keychain, jamais hardcodÃ©e.  
RÃ©fÃ©rencesÂ : OWASP A02, CWEâ€‘311.

### [BASSE] Sâ€‘2 â€” Import dâ€™archives sans limite de taille

CatÃ©gorieÂ : Durcissement archives  
Fichier(s)Â : `rekall/archive.py:228-262`  
DescriptionÂ : `entries.json` est lu en mÃ©moire entiÃ¨re sans contrÃ´le de taille; un fichier `.rekall` trÃ¨s volumineux ou malveillant peut provoquer une consommation mÃ©moire Ã©levÃ©e.  
ImpactÂ : DoS local (crash/import lent).  
PreuveÂ : `entries_data = self._zipf.read("entries.json")` (`rekall/archive.py:228`) puis dÃ©codage complet (`rekall/archive.py:261-262`).  
RemÃ©diationÂ : vÃ©rifier `ZipInfo.file_size` avant lecture (ex: limite configurable 50â€“200â€¯MB) et refuser auâ€‘delÃ .  
RÃ©fÃ©rencesÂ : CWEâ€‘400.

---

## ğŸ”§ FINDINGS QUALITÃ‰ & MAINTENABILITÃ‰

### [HAUTE] Mâ€‘1 â€” Modules â€œmainâ€ encore monolithiques

CatÃ©gorieÂ : MaintenabilitÃ©, antiâ€‘pattern God Object  
Fichier(s)Â : `rekall/tui_main.py:1`, `rekall/cli_main.py:1`, `rekall/db.py:441`  
DescriptionÂ : malgrÃ© une modularisation rÃ©cente, trois fichiers restent massifsÂ :  
- `rekall/tui_main.py` ~7872 LOC  
- `rekall/cli_main.py` ~4643 LOC  
- `rekall/db.py` ~4502 LOC  
Ils combinent orchestration, logique mÃ©tier, IO et UI.  
ImpactÂ : complexitÃ© cognitive, difficultÃ© de test/refactor, risques de rÃ©gression.  
PreuveÂ : comptage LOC local (`wc -l`).  
RemÃ©diationÂ :
- extraire commandes CLI en sousâ€‘modules (`rekall/cli/commands/*`).  
- dÃ©couper TUI en Ã©crans/widgets isolÃ©s (Textual) + services injectÃ©s.  
- scinder DB en `repositories` (entries/tags/sources/links).  
RÃ©fÃ©rencesÂ : SOLID (SRP), God Object.

### [MOYENNE] Mâ€‘2 â€” Chemin de backups incohÃ©rent (global vs projet)

CatÃ©gorieÂ : CohÃ©rence persistance / UX  
Fichier(s)Â :  
- `rekall/backup.py:84-92` (dÃ©faut global `~/.rekall/backups`)  
- `rekall/cli_main.py:2120-2147` (commande `rekall backup` se base sur dÃ©faut global)  
- `rekall/cli_main.py:1523` et `rekall/tui_main.py:6578` (backups dâ€™import en `db_path.parent/backups`)  
DescriptionÂ : deux logiques coexistentÂ :  
1. backups â€œmaintenanceâ€ globales;  
2. backups â€œsafety/importâ€ locales au projet.  
ImpactÂ : confusion utilisateur, risque de chercher/restaurer au mauvais endroit, difficultÃ© multiâ€‘workspaces.  
PreuveÂ : chemins codÃ©s en dur (`rekall/backup.py:90-91`) vs chemins relatifs au DB (`rekall/cli_main.py:1523`).  
RemÃ©diationÂ :
- ajouter un paramÃ¨tre unique `config.backups_dir` rÃ©solu par `PathResolver`;  
- harmoniser toutes les fonctions/commandes sur ce chemin, avec fallback explicite.  

### [MOYENNE] Mâ€‘3 â€” TODO fonctionnel embeddings non finalisÃ©

CatÃ©gorieÂ : Features incomplÃ¨tes  
Fichier(s)Â : `rekall/cli_main.py:1299`  
DescriptionÂ : â€œTODO: Implement actual embedding-based searchâ€.  
ImpactÂ : dette fonctionnelle, risque de divergence future doc/comportement.  
RemÃ©diationÂ : soit implÃ©menter, soit retirer le flag/commande correspondante si non prÃ©vue.

### [BASSE] Mâ€‘4 â€” Hook clipboard macOS only

CatÃ©gorieÂ : PortabilitÃ©  
Fichier(s)Â : `rekall/tui_main.py:3120`  
DescriptionÂ : usage direct de `pbcopy`.  
ImpactÂ : crash sur Linux/Windows si chemin exÃ©cutÃ©.  
RemÃ©diationÂ : wrapper multiâ€‘OS (ex: `pyperclip`) ou dÃ©tection OS + fallback.

### [BASSE] Mâ€‘5 â€” Suppression large de warnings TLS

CatÃ©gorieÂ : QualitÃ©/sÃ©curitÃ© opÃ©rationnelle  
Fichier(s)Â : `rekall/__init__.py:9-11`  
DescriptionÂ : ignore global des warnings `urllib3 OpenSSL`.  
ImpactÂ : peut masquer un runtime TLS faible lors des features rÃ©seau optâ€‘in.  
RemÃ©diationÂ : rÃ©duire le filtre au strict nÃ©cessaire ou loguer un warning contextuel.

---

## ğŸ—ï¸ FINDINGS ARCHITECTURE & ORGANISATION

### [MOYENNE] Aâ€‘1 â€” FaÃ§ades OK mais services encore couplÃ©s aux UI

CatÃ©gorieÂ : SÃ©paration des couches  
Fichier(s)Â : `rekall/cli_main.py`, `rekall/tui_main.py`  
DescriptionÂ : packages `services/` et `infra/` existent, mais une partie de la logique mÃ©tier (promotion/scoring/import) reste pilotÃ©e directement dans les UI â€œmainâ€.  
ImpactÂ : tests plus difficiles, duplication possible entre CLI/TUI/MCP.  
RemÃ©diationÂ : dÃ©placer la logique pure dans `services/*`, laisser CLI/TUI comme orchestrateurs fins (DI).  

---

## âš™ï¸ CI/CD, SUPPLY CHAIN & OBSERVABILITÃ‰

### [BASSE] Câ€‘1 â€” CI ne couvre pas Python 3.9

CatÃ©gorieÂ : CI/CD  
Fichier(s)Â : `.github/workflows/ci.yml:16-18`  
DescriptionÂ : matrice Python `3.10â€“3.13` alors que `requires-python >=3.9`.  
ImpactÂ : compatibilitÃ© 3.9 non garantie.  
RemÃ©diationÂ : ajouter `3.9` Ã  la matrice ou ajuster le support officiel.

**Points forts CI/supply chain**
- `uv.lock` versionnÃ© et vÃ©rifiÃ© en CI (`ci.yml:42-43`).  
- `pip-audit --strict` + `gitleaks` automatiques (`ci.yml:58-61`).  
- versions bornÃ©es dans `pyproject.toml:31-57`.  

### [BASSE] Oâ€‘1 â€” ObservabilitÃ© limitÃ©e

CatÃ©gorieÂ : Logs/diagnostic  
Fichier(s)Â : logs dispersÃ©s (`rekall/*`)  
DescriptionÂ : logging standard Python; pas de logs structurÃ©s ni de niveau â€œauditâ€ dÃ©diÃ©.  
ImpactÂ : debug plus lent sur incidents utilisateurs ou intÃ©grations MCP.  
RemÃ©diationÂ : ajouter un mode `--debug` plus riche + option log JSONL.

---

## ğŸ¤– HYGIÃˆNE & CONTRIBUTIONS IA

- Docs research contiennent du contenu gÃ©nÃ©rÃ©/assistÃ© IA (ex: `docs/research-sources-souvenirs-integration.md:482`).  
- Aucun marqueur IA notable dans le code applicatif.  
- RecoÂ : taguer les docs gÃ©nÃ©rÃ©es comme â€œÃ  validerâ€ et lier aux specs/tests quand elles introduisent une logique.

---

## ğŸ“ˆ MÃ‰TRIQUES DÃ‰TAILLÃ‰ES

| MÃ©trique | Valeur | Seuil | Statut |
|---|---:|---:|---|
| Taille max fichier | `rekall/tui_main.py` 7872 LOC | <2000 | Ã€ rÃ©duire |
| Autres fichiers critiques | `rekall/cli_main.py` 4643, `rekall/db.py` 4502 LOC | <1500 | Ã€ rÃ©duire |
| i18n | `rekall/i18n.py` 4148 LOC | <2000 | OK (donnÃ©es) |
| Duplication visible | faible | n/a | OK |
| TODO critiques | 1 (embeddings) | 0 | Ã€ corriger |
| ObservabilitÃ© | basique | adaptÃ©e | Ã€ amÃ©liorer |

---

## ğŸ“‹ DÃ‰PENDANCES VULNÃ‰RABLES

Scan CVE dÃ©taillÃ© non exÃ©cutÃ© horsâ€‘ligne. La CI exÃ©cute `pip-audit --strict` Ã  chaque PR (`.github/workflows/ci.yml:58-59`).  

| DÃ©pendance | Version actuelle | CVE | SÃ©vÃ©ritÃ© | Reco |
|---|---|---|---|---|
| `typer` | `>=0.12,<1` | CI pipâ€‘audit | n/a | OK |
| `rich` | `>=13,<14` | CI pipâ€‘audit | n/a | OK |
| `textual` | `>=0.89,<1` | CI pipâ€‘audit | n/a | OK |
| `httpx` | `>=0.25,<1` | CI pipâ€‘audit | n/a | OK |
| `sentence-transformers` (extra) | `>=2.2,<3` | CI pipâ€‘audit | n/a | OK |

---

## âœ… POINTS POSITIFS

- **Localâ€‘first solide**Â : aucune tÃ©lÃ©mÃ©trie, fichiers protÃ©gÃ©s par permissions strictes (`rekall/utils.py:15-36`).  
- **SSRF durci**Â : validation hostname + DNS + blocage IP privÃ©es (`rekall/connectors/base.py:175-228`).  
- **SQLite bien gÃ©rÃ©e**Â : WAL + FK + migrations atomiques (`rekall/db.py:465-533`).  
- **Backups sÃ»rs**Â : WAL checkpoint + integrity check (`rekall/backup.py:95-155`).  
- **Supply chain mature**Â : lockfile, versions bornÃ©es, CI sÃ©curitÃ©.  
- **Docs et DX** au-dessus de la moyenne (multilingue, SECURITY/CONTRIBUTING, specs).

---

## ğŸ—ºï¸ ROADMAP DE REMÃ‰DIATION

1. **ImmÃ©diat (<1 semaine)**
   - Plan de dÃ©coupage de `tui_main.py`, `cli_main.py`, `db.py` + extraction services.  
   - Clarifier dans README le caractÃ¨re optâ€‘in des features rÃ©seau (embeddings/linkâ€‘rot).  
   - Ajouter Python 3.9 au CI ou retirer du support.
2. **Court terme (<1 mois)**
   - Harmoniser `backups_dir` via config/PathResolver.  
   - Ajouter limite de taille aux imports dâ€™archives.  
   - Wrapper clipboard multiâ€‘OS.
3. **Moyen terme (<3 mois)**
   - Refactor DB en repositories + tests ciblÃ©s.  
   - AmÃ©liorer logs (debug/audit JSONL).
4. **Long terme**
   - Support optionnel de chiffrement SQLCipher.  
   - Bench/perf sur bases volumineuses (embeddings, imports).  

