# Audit 360 du projet Rekall

Date du rapport: 2025-12-12  
Repository audité: workspace local `/Users/moi/Nextcloud/10.Scripts/16.devKMS`  
Langage principal: Python  
Type d’application: CLI/TUI local-first de gestion de connaissance développeur, SQLite + FTS5, serveur MCP optionnel, connecteurs d’historiques d’outils IA.  
Contexte d’usage pressenti: alpha/outillage interne ou personnel, publié PyPI.

## Résumé Exécutif

- Score global de santé: **B-** (base solide, mais lacunes CI/supply-chain et quelques incohérences produit-doc).
- Scores par catégorie:
  - Sécurité: **B**
  - Qualité de code: **B-**
  - Architecture: **B-**
  - Tests: **B**
  - Performance/Scalabilité: **B**
  - Observabilité/Exploitabilité: **C+**
  - Conformité/Licences: **C**
  - CI/CD & Supply Chain: **D**
- Top 5 problèmes critiques à résoudre immédiatement:
  1. Absence de CI (tests/lint/scans non exécutés automatiquement).
  2. Pas de lockfile et versions “>=” larges → risque supply-chain/reproductibilité.
  3. Mismatch docs/code sur embeddings + dépendances optionnelles non déclarées → comportement réseau implicite.
  4. Validation d’URL anti-localhost contournable (soft SSRF locale) dans les connecteurs.
  5. Gestion TOML fragile et silencieuse sur erreurs → risque de config incohérente/inattendue.
- Dette technique: **modérée → élevée** si la base grossit sans modularisation/CI.

## Findings Critiques (Sécurité & Données)

### [HAUTE] Absence de CI/CD et de scans automatisés

- Catégorie: CI/CD, SAST, dépendances  
- Fichier(s): `.github/` (aucun `.github/workflows/*`)  
- Description: le repo ne contient pas de workflow GitHub Actions (seulement `.github/FUNDING.yml`). Aucune exécution automatique de `pytest`, `ruff`, détection de secrets ou audit dépendances.  
- Impact: régressions non détectées, vulnérabilités non surveillées, baisse de confiance pour une publication PyPI.  
- Preuve: listing `.github` ne contient que `.github/FUNDING.yml`.  
- Remédiation:
  - Ajouter un workflow CI: matrice Python 3.9–3.13, cache pip, `ruff check`, `pytest -q`.
  - Ajouter un job `pip-audit`/`safety` + secret-scan (Gitleaks) et Dependabot/Renovate.  
- Références: OWASP A06 (Vulnerable/Outdated Components), A08 (Software and Data Integrity Failures).

### [HAUTE] Dépendances non verrouillées / versions trop larges

- Catégorie: Supply chain, dépendances  
- Fichier(s): `pyproject.toml:31`  
- Description: dépendances principales en `>=` sans lockfile (`poetry.lock`, `uv.lock`, etc.).  
- Impact: builds non reproductibles, risque d’introduire une CVE via update transitive, difficulté de support.  
- Preuve: `dependencies = ["typer>=0.12.0", "httpx>=0.25.0", ...]` (`pyproject.toml:31-40`).  
- Remédiation:
  - Choisir un outil de lock (Poetry, uv, pip-tools) et committer le lockfile.
  - Resserer les bornes (`>=` + `< major+1`) et activer updates automatiques.  
- Références: OWASP A06, CWE-1104.

### [HAUTE] Embeddings: comportement réseau implicite + incohérence docs/code + extras manquants

- Catégorie: Composants IA, réseau, docs, supply chain  
- Fichier(s): `docs/getting-started.md:146`, `rekall/embeddings.py:47`, `pyproject.toml:42`  
- Description:
  - La doc annonce “download EmbeddingGemma” à la première recherche (`docs/getting-started.md:146`),
  - Le code utilise par défaut un modèle HF sentence-transformers `all-MiniLM-L6-v2` (`rekall/embeddings.py:47`) et requiert l’installation manuelle de `sentence-transformers numpy` (`rekall/embeddings.py:95-99`),
  - Ces deps ne sont pas déclarées en optional extras (seul extra `dev` existe, `pyproject.toml:42`).  
- Impact: surprise utilisateur (téléchargement réseau non anticipé), install incomplète, risque d’échec silencieux, surface supply-chain via modèles téléchargés.  
- Preuve:
  - Doc: “downloads EmbeddingGemma (~200MB)” (`docs/getting-started.md:146`).
  - Code: `model_name="sentence-transformers/all-MiniLM-L6-v2"` (`rekall/embeddings.py:47`).  
- Remédiation:
  - Aligner la doc sur le modèle réellement utilisé et expliciter le téléchargement HF.
  - Ajouter `[project.optional-dependencies].embeddings = ["sentence-transformers>=x,<y","numpy>=x,<y"]`.
  - Prévoir un mode “offline strict” + vérification de présence du modèle avant usage.  
- Références: OWASP A08, A06.

### [MOYENNE] Validation d’URL “quarantine” contournable (soft SSRF locale)

- Catégorie: Validation d’entrées, SSRF  
- Fichier(s): `rekall/connectors/base.py:55`, `rekall/connectors/base.py:151`  
- Description:
  - `validate_url` applique une regex de quarantaine sur `parsed.netloc` (`rekall/connectors/base.py:151`) avec patterns simples (`rekall/connectors/base.py:55-63`).
  - `netloc` inclut userinfo et port, donc des URL comme `https://localhost@evil.com/` ou `https://127.0.0.1.nip.io/` peuvent passer.
  - IPv6 privées non couvertes.  
- Impact: si enrichment/link-rot est activé, la CLI peut faire des requêtes vers des hôtes internes inattendus. Risque surtout local.  
- Preuve:
  - Patterns: `QUARANTINE_PATTERNS` (`rekall/connectors/base.py:55-64`).
  - Host check sur `parsed.netloc` (`rekall/connectors/base.py:151-153`).  
- Remédiation:
  - Utiliser `parsed.hostname` (sans userinfo/port), normaliser via `idna`.
  - Bloquer plages privées IPv4/IPv6 (`fc00::/7`, `fe80::/10`, etc.).
  - Optionnel: résolution DNS et blocage si IP privée (attention DNS rebinding).  
- Références: OWASP A10 (SSRF), CWE-918.

### [MOYENNE] Config TOML fragile et erreurs silencieusement ignorées

- Catégorie: Configuration, robustesse, validation  
- Fichier(s): `rekall/config.py:133`, `rekall/config.py:167`, `rekall/config.py:185`  
- Description:
  - Lecture TOML attrape toute exception et retourne `{}` (`rekall/config.py:133-137`), masquant les erreurs de parsing.
  - Écriture TOML manuelle via `_format_toml_value` (`rekall/config.py:167-194`) sans gestion de listes, échappement de guillemets, types complexes.
  - Certaines valeurs deviennent chaînes (`rekall/config.py:258`).  
- Impact: configuration corrompue ou ignorée sans alerte → comportements inattendus; désactivation involontaire de protections/flags.  
- Preuve: `except Exception: return {}` (`rekall/config.py:136-137`).  
- Remédiation:
  - Utiliser une lib d’écriture TOML (tomli-w/tomlkit).
  - Remonter les erreurs à l’utilisateur (log + message CLI).
  - Valider le schéma (pydantic/dataclass validation).  
- Références: OWASP A05, CWE-703.

### [MOYENNE] Données sensibles non chiffrées au repos (SQLite)

- Catégorie: Chiffrement, PII/RGPD  
- Fichier(s): `rekall/db.py:459`, absence de `sqlcipher`/encryption  
- Description: SQLite stocke potentiellement notes, URLs, extraits, prompts. Aucun support de chiffrement au repos n’est présent.  
- Impact: fuite possible si machine compromise/backup partagé; non-conformité potentielle selon usage (PII, secrets projet).  
- Preuve: connexion SQLite standard (`rekall/db.py:459-465`) et aucune occurrence d’encryption.  
- Remédiation:
  - Documenter clairement le risque et recommander un disque chiffré.
  - Optionnel: intégrer SQLCipher via extra `encryption` + gestion clé (env/OS keychain).  
- Références: OWASP A02, CWE-311.

## Findings Qualité & Maintenabilité

### [HAUTE] Modules monolithiques très volumineux

- Catégorie: Maintenabilité, SOLID, modularisation  
- Fichier(s): `rekall/cli.py`, `rekall/tui.py`, `rekall/db.py`  
- Description: fichiers principaux dépassent 4k–7.8k lignes (`rekall/cli.py` 4441 LOC, `rekall/db.py` 4499, `rekall/tui.py` 7875).  
- Impact: complexité cognitive élevée, risques de régression, onboarding difficile.  
- Preuve: `wc -l` sur ces fichiers.  
- Remédiation: extraire par domaines: commandes CLI par sous-modules, services DB en “repositories”, UI TUI en composants Textual séparés.

### [MOYENNE] Chemin de backups incohérent avec la résolution XDG/local

- Catégorie: Cohérence config/paths  
- Fichier(s): `rekall/backup.py:85`, `rekall/paths.py:230`  
- Description: backups par défaut forcés sur `~/.rekall/backups` (`rekall/backup.py:91`) alors que le projet supporte `REKALL_HOME`, `.rekall/` local et XDG (`rekall/paths.py:230+`).  
- Impact: confusion, backups pas co‑localisés au projet, surprise en environnement multi‑workspaces.  
- Remédiation: aligner sur `ResolvedPaths.data_dir`/config, et exposer un paramètre global `backups_dir`.

### [MOYENNE] TODO critique sur embeddings non finalisés

- Catégorie: Features incomplètes  
- Fichier(s): `rekall/cli.py:1199`  
- Description: commentaire “TODO: Implement actual embedding-based search”.  
- Impact: dette fonctionnelle, divergence doc/comportement.  
- Remédiation: implémenter ou retirer/clarifier le flag et la doc.

### [BASSE] Suppression globale de warnings sécurité

- Catégorie: Qualité, sécurité opérationnelle  
- Fichier(s): `rekall/__init__.py:10-11`  
- Description: filtres `urllib3 OpenSSL`/`NotOpenSSLWarning` masqués.  
- Impact: peut cacher un environnement TLS faible lors d’usages réseau optionnels.  
- Remédiation: limiter au strict nécessaire ou logger un warning explicite.

### [BASSE] Portabilité clipboard via subprocess

- Catégorie: UX/Portabilité  
- Fichier(s): `rekall/tui.py:3123`  
- Description: `subprocess.run(["pbcopy"], ...)` macOS uniquement.  
- Impact: erreur sur Linux/Windows si chemin exécuté.  
- Remédiation: wrapper multi‑OS ou fallback.

## Findings Architecture & Organisation

### [MOYENNE] Frontières “présentation vs domaine vs infra” à renforcer

- Catégorie: Architecture, séparation des couches  
- Fichier(s): `rekall/cli.py`, `rekall/tui.py`, `rekall/db.py`  
- Description: logique métier/IO/rendu UI parfois entremêlés dans les mêmes modules.  
- Impact: tests plus difficiles, réutilisation limitée (serveur MCP vs CLI).  
- Remédiation: définir `services/` (domain), `infra/` (db, http), `ui/` (cli/tui), et injecter les dépendances.

### [BASSE] Hooks shell comme surface d’intégration

- Catégorie: Intégrations  
- Fichier(s): `rekall/data/hooks/rekall-webfetch.sh:12-46`  
- Description: hook PostToolUse lit du JSON et appelle `rekall` en background. Bien quoté mais dépend de `jq`.  
- Impact: faible; risque d’échec silencieux si `jq` absent.  
- Remédiation: vérifier dépendance `jq` à l’installation ou fournir fallback Python.

## CI/CD, Supply Chain & Observabilité

- Pas de pipeline CI (voir findings critiques).  
- Pas de scans secrets/dépendances automatiques.  
- Pas de release automatisée (tag → PyPI).  
- Logging: usage standard `logging` + Rich/Textual; pas de logs structurés ni corrélation.  
- Réseau optionnel:
  - `rekall/enrichment.py:191-197` fait des GET avec timeout.
  - `rekall/link_rot.py:45-73` fait des HEAD.  
  Ces features doivent être documentées comme “réseau activé”.

## Hygiène & Contributions IA

- Indices IA dans la documentation de recherche (ex: note explicite `docs/research-sources-souvenirs-integration.md:482`).  
- Pas de marqueurs IA évidents dans le code applicatif.  
- Recommandation: préciser le statut “à valider” pour les specs/docs générées et ajouter des tests quand elles introduisent de la logique.

## Métriques Détaillées (approximées)

| Métrique | Valeur | Seuil | Statut |
|---|---:|---:|---|
| Taille fichier max | `rekall/tui.py` 7875 LOC | <2000 | À corriger |
| Autres fichiers critiques | `rekall/db.py` 4499, `rekall/cli.py` 4441 LOC | <1500 | À corriger |
| Duplication visible | faible | n/a | OK |
| TODOs en zone critique | 1 notable | 0 | À corriger |
| Robustesse config | fragile | robuste | À corriger |
| Observabilité | basique | adaptée usage | À surveiller |

## Dépendances Vulnérables

Audit CVE non exécuté hors‑ligne.  
Action recommandée: ajouter `pip-audit` en CI et scanner à chaque release.

| Dépendance | Version actuelle | CVE | Sévérité | Version corrigée recommandée |
|---|---|---|---|---|
| `typer` | `>=0.12.0` | N/A (non scanné) | N/A | pinner + lock |
| `rich` | `>=13.0.0` | N/A | N/A | pinner + lock |
| `textual` | `>=0.89.0` | N/A | N/A | pinner + lock |
| `httpx` | `>=0.25.0` | N/A | N/A | pinner + lock |
| `beautifulsoup4` | `>=4.12.0` | N/A | N/A | pinner + lock |

## Points Positifs

- Architecture local-first claire; SQLite FTS5 + WAL bien configuré (`rekall/db.py:1`, `rekall/db.py:463`).  
- Migrations versionnées via `PRAGMA user_version`.  
- Backups flush WAL et integrity_check (`rekall/backup.py`).  
- Tests et outillage Ruff/Pytest déjà en place (`pyproject.toml:65-77`).  
- Docs riches, multilingues, `SECURITY.md` et `CONTRIBUTING.md` présents.  
- Pas de patterns dangereux repérés (pas de `eval/exec/pickle`, pas de secrets).

## Roadmap de Remédiation

1. Immédiat (<1 semaine)
   - Ajouter CI GitHub Actions (tests + ruff + secret scan + pip-audit).
   - Introduire lockfile et bornes de versions strictes.
   - Corriger doc embeddings + déclarer extra `embeddings` + expliciter réseau.
2. Court terme (<1 mois)
   - Durcir `BaseConnector.validate_url` contre bypass + IPv6 privées.
   - Refaire la sérialisation TOML et remonter les erreurs à l’utilisateur.
   - Ajouter un `LICENSE` racine cohérent avec MIT déclaré.
3. Moyen terme (<3 mois)
   - Modulariser `cli.py`, `tui.py`, `db.py` par domaines.
   - Clarifier/finir les features embeddings (retirer TODO).
   - Améliorer logs (niveaux, messages utilisateurs, option verbose).
4. Long terme
   - Option chiffrement SQLite (SQLCipher) si usage sensible.
   - Bench/perf sur gros volumes et pagination/streaming pour vues TUI.
   - Stabiliser l’API MCP (versioning, compat).
